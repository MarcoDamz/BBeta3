# Cloud Build configuration for ChatAgentB
# Déploiement automatique sur Cloud Run

steps:
  # Build Backend Image
  - name: "gcr.io/cloud-builders/docker"
    id: "build-backend"
    args:
      - "build"
      - "-t"
      - "gcr.io/$PROJECT_ID/chatagentb-backend:latest"
      - "-f"
      - "backend/Dockerfile.cloudrun"
      - "./backend"

  # Build Worker Image
  - name: "gcr.io/cloud-builders/docker"
    id: "build-worker"
    args:
      - "build"
      - "-t"
      - "gcr.io/$PROJECT_ID/chatagentb-worker:latest"
      - "-f"
      - "backend/Dockerfile.worker"
      - "./backend"

  # Build Frontend Image
  - name: "gcr.io/cloud-builders/docker"
    id: "build-frontend"
    args:
      - "build"
      - "-t"
      - "gcr.io/$PROJECT_ID/chatagentb-frontend:latest"
      - "-f"
      - "frontend/Dockerfile.cloudrun"
      - "--build-arg"
      - "VITE_API_URL=https://chatagentb-backend-548740531838.europe-west1.run.app/api"
      - "./frontend"

  # Push Backend Image
  - name: "gcr.io/cloud-builders/docker"
    id: "push-backend"
    args: ["push", "gcr.io/$PROJECT_ID/chatagentb-backend:latest"]
    waitFor: ["build-backend"]

  # Push Worker Image
  - name: "gcr.io/cloud-builders/docker"
    id: "push-worker"
    args: ["push", "gcr.io/$PROJECT_ID/chatagentb-worker:latest"]
    waitFor: ["build-worker"]

  # Push Frontend Image
  - name: "gcr.io/cloud-builders/docker"
    id: "push-frontend"
    args: ["push", "gcr.io/$PROJECT_ID/chatagentb-frontend:latest"]
    waitFor: ["build-frontend"]

  # Deploy Backend to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-backend"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "chatagentb-backend"
      - "--image"
      - "gcr.io/$PROJECT_ID/chatagentb-backend:latest"
      - "--region"
      - "europe-west1"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--memory"
      - "2Gi"
      - "--cpu"
      - "2"
      - "--timeout"
      - "300"
      - "--max-instances"
      - "10"
      - "--no-cpu-throttling"
      - "--set-cloudsql-instances"
      - "bridgetbeta:europe-west1:chatagentb-db"
      - "--set-env-vars"
      - "DEBUG=False,POSTGRES_HOST=/cloudsql/bridgetbeta:europe-west1:chatagentb-db,POSTGRES_DB=chatagentb,POSTGRES_USER=chatagentb,REDIS_HOST=10.23.123.163,CELERY_BROKER_URL=redis://10.23.123.163:6379/0"
      - "--set-secrets"
      - "SECRET_KEY=chatagentb-django-secret:latest,POSTGRES_PASSWORD=chatagentb-db-password:4,OPENAI_API_KEY=chatagentb-openai-api-key:latest"
    waitFor: ["push-backend"]

  # Deploy Worker to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-worker"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "chatagentb-worker"
      - "--image"
      - "gcr.io/$PROJECT_ID/chatagentb-worker:latest"
      - "--region"
      - "europe-west1"
      - "--platform"
      - "managed"
      - "--no-allow-unauthenticated"
      - "--memory"
      - "2Gi"
      - "--cpu"
      - "2"
      - "--timeout"
      - "3600"
      - "--max-instances"
      - "5"
      - "--set-cloudsql-instances"
      - "bridgetbeta:europe-west1:chatagentb-db"
      - "--set-env-vars"
      - "DEBUG=False,POSTGRES_HOST=/cloudsql/bridgetbeta:europe-west1:chatagentb-db,POSTGRES_DB=chatagentb,POSTGRES_USER=chatagentb,REDIS_HOST=10.23.123.163,CELERY_BROKER_URL=redis://10.23.123.163:6379/0"
      - "--set-secrets"
      - "SECRET_KEY=chatagentb-django-secret:latest,POSTGRES_PASSWORD=chatagentb-db-password:4,OPENAI_API_KEY=chatagentb-openai-api-key:latest"
    waitFor: ["push-worker"]

  # Deploy Frontend to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-frontend"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "chatagentb-frontend"
      - "--image"
      - "gcr.io/$PROJECT_ID/chatagentb-frontend:latest"
      - "--region"
      - "europe-west1"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--memory"
      - "512Mi"
      - "--cpu"
      - "1"
      - "--max-instances"
      - "10"
    waitFor: ["push-frontend"]

# Substitutions (à définir dans le trigger Cloud Build)
options:
  machineType: "E2_HIGHCPU_8"
  logging: CLOUD_LOGGING_ONLY

images:
  - "gcr.io/$PROJECT_ID/chatagentb-backend:latest"
  - "gcr.io/$PROJECT_ID/chatagentb-worker:latest"
  - "gcr.io/$PROJECT_ID/chatagentb-frontend:latest"
